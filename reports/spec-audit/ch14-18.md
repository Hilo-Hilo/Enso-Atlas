# Chapters 14–18 spec audit (high-confidence mismatches only)

## 1) Chapter 14.2 overstates removal of global fallback assumptions

**Old:**
> The backend resolves all dataset paths from `config/projects.yaml`; no API endpoint should rely on flat global `data/tcga_full` assumptions.

**New (suggested):**
> The backend resolves project-scoped dataset paths from `config/projects.yaml` when `project_id` is provided. Legacy non-project requests still use compatibility fallbacks (including `data/tcga_full` paths).

---

## 2) Chapter 14.3 overstates `_resolve_embedding_path()` coverage across analysis endpoints

**Old:**
> Runtime routing uses `_resolve_embedding_path()` to enforce level-0 dense-only lookup for analysis and heatmap workloads, preventing sparse/dense mixing across projects.

**New (suggested):**
> Runtime routing uses `_resolve_embedding_path()` for `/api/analyze-multi` and heatmap endpoints to enforce level-0 dense-only lookup. Some legacy analysis/report endpoints still load `{embeddings_dir}/{slide_id}.npy` directly.

---

## 3) Chapter 15.1 states offline mode as already enforced, but deployment defaults are online-capable

**Old:**
> **No cloud dependencies at runtime:** `TRANSFORMERS_OFFLINE=1` and `HF_HUB_OFFLINE=1` enforce air-gapped operation

**New (suggested):**
> **Offline-capable runtime:** Set `TRANSFORMERS_OFFLINE=1` and `HF_HUB_OFFLINE=1` to enforce air-gapped operation after model pre-caching (Compose defaults are `0`).

---

## 4) Chapter 15.2 claims `report_generated` audit event, but that event is not emitted

**Old (audit events table row):**
| `report_generated` | MedGemma report |

**New (suggested):**
| `batch_analysis_completed` | Batch slide analysis (synchronous) |

(If keeping `report_generated` in spec, code instrumentation is needed first.)

---

No additional high-confidence text/code mismatches found in Chapters 16–18.