# Chapter 19 (Appendices A–D) spec audit (high-confidence mismatches only)

## 1) Appendix A: `MIL_ARCHITECTURE` default is incorrect

**Old (Appendix A row):**
`MIL_ARCHITECTURE` default: `transmil`

**New (suggested):**
`MIL_ARCHITECTURE` default: `clam` *(Docker Compose explicitly overrides to `transmil`)*

**Evidence:**
- Spec: `TECHNICAL_SPECIFICATION.md:2883`
- Runtime default: `src/enso_atlas/api/main.py:1154`
- Compose override: `docker/docker-compose.yaml:21`

---

## 2) Appendix A: `NEXT_PUBLIC_API_URL` default behavior is overstated as empty/same-origin

**Old (Appendix A row):**
`NEXT_PUBLIC_API_URL` default: *(empty, same-origin `/api`)*

**New (suggested):**
`NEXT_PUBLIC_API_URL` is optional for browser calls, but Next.js server rewrites default to `http://127.0.0.1:8003` when unset.

**Evidence:**
- Spec: `TECHNICAL_SPECIFICATION.md:2892`
- Rewrite fallback: `frontend/next.config.mjs:29`
- Example env value (non-empty): `frontend/.env.example:4`

---

## 3) Appendix A omits `TRANSFORMERS_CACHE` (actively used)

**Old:**
No `TRANSFORMERS_CACHE` entry in Appendix A table.

**New (suggested row):**
| `TRANSFORMERS_CACHE` | `/app/cache/huggingface` | Transformers cache path (fallback when `HF_HOME` is unset) |

**Evidence:**
- Compose sets it: `docker/docker-compose.yaml:18`
- Dockerfile sets it: `docker/Dockerfile:77`
- Runtime fallback lookup uses it: `src/enso_atlas/api/main.py:5628-5635`, `src/enso_atlas/embedding/embedder.py:74-76`

---

## 4) Appendix B API tree is missing active modules (`model_scope.py`, `heatmap_grid.py`)

**Old (Appendix B `src/enso_atlas/api/` block):**
Lists API files but omits `model_scope.py` and `heatmap_grid.py`.

**New (suggested):**
Add:
- `model_scope.py`
- `heatmap_grid.py`

**Evidence:**
- Spec API file block: `TECHNICAL_SPECIFICATION.md:2977-2987`
- Both modules are imported by main API: `src/enso_atlas/api/main.py:26-31`

---

## 5) Appendix B frontend tree omits `/app/projects/page.tsx`

**Old (Appendix B frontend app block):**
Includes `layout.tsx`, `page.tsx`, `slides/page.tsx` only.

**New (suggested):**
Add:
- `frontend/src/app/projects/page.tsx`  # Project management page

**Evidence:**
- Spec frontend app block: `TECHNICAL_SPECIFICATION.md:2909-2911`
- Projects page file exists: `frontend/src/app/projects/page.tsx:1`
- Header links to `/projects`: `frontend/src/components/layout/Header.tsx:392`

---

## 6) Appendix B model artifact listing is stale (`transmil_best.pt` as canonical)

**Old (Appendix B `models/` block):**
Includes `transmil_best.pt` as the listed checkpoint artifact.

**New (suggested):**
Document checkpoint paths as model/project-specific (not a single canonical file). At minimum, note runtime default `models/clam_attention.pt` plus project overrides.

**Evidence:**
- Spec model block: `TECHNICAL_SPECIFICATION.md:2966-2969`
- Runtime default checkpoint path: `src/enso_atlas/api/main.py:708`
- Project-specific checkpoints differ: `config/projects.yaml:129`, `config/projects.yaml:166`

---

## 7) Appendix C Decision #1 says “no migration framework,” but code has explicit schema-versioned migrations

**Old (Appendix C #1):**
“No migration framework for small schema.”

**New (suggested):**
Raw SQL + asyncpg is still correct, but schema evolution is handled by in-code migrations with `schema_version` tracking (v2–v5 migration functions).

**Evidence:**
- Spec statement: `TECHNICAL_SPECIFICATION.md:3030-3031`
- Schema version table: `src/enso_atlas/api/database.py:154-161`
- Migration execution: `src/enso_atlas/api/database.py:209-213`

---

## 8) Appendix D error-code table is incomplete (missing `403` and `409`)

**Old (Appendix D):**
Only lists `400`, `404`, `500`, `503`.

**New (suggested):**
Add at least:
- `403` — model not allowed for project scope
- `409` — coordinate/conflict state prevents truthful heatmap rendering (`COORDS_REQUIRED_FOR_HEATMAP`)

**Evidence:**
- Spec table: `TECHNICAL_SPECIFICATION.md:3053-3058`
- `403` emission: `src/enso_atlas/api/model_scope.py:102-106`
- `409` emission: `src/enso_atlas/api/main.py:6527-6534`
