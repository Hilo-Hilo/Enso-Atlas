# Chapter 6 Audit (AI assistant workflow + SSE/session behavior)

Scope: `TECHNICAL_SPECIFICATION.md:878-958`

## Verified claims (implemented as written)

1. **Seven-step workflow is implemented (including semantic search).**
   - Steps enum includes `initialize`, `analyze`, `retrieve`, `semantic_search`, `compare`, `reason`, `report`: `src/enso_atlas/agent/workflow.py:25-35`
   - `run_workflow()` executes the same 7-step order: `src/enso_atlas/agent/workflow.py:215-238`

2. **SSE streaming contract is implemented for analysis and follow-up.**
   - Analyze stream emits SSE `data: {...}` with `step/status/message/reasoning/data/timestamp/duration_ms`: `src/enso_atlas/agent/routes.py:83-109`
   - Endpoint is `POST /api/agent/analyze` with `text/event-stream`: `src/enso_atlas/agent/routes.py:122-169`
   - Follow-up also streams SSE: `src/enso_atlas/agent/routes.py:172-229`

3. **Session state is in-memory via `AgentState` and reused for follow-ups.**
   - In-memory session store: `self._sessions: Dict[str, AgentState]`: `src/enso_atlas/agent/workflow.py:167-168`
   - Follow-up reads prior session state and appends conversation history without rerunning workflow: `src/enso_atlas/agent/workflow.py:1194-1244`

4. **Frontend consumes SSE stream from `/api/agent/analyze` and `/api/agent/followup`.**
   - Analyze SSE parsing: `frontend/src/components/panels/AIAssistantPanel.tsx:546-624`
   - Follow-up SSE parsing: `frontend/src/components/panels/AIAssistantPanel.tsx:650-712`

---

## High-confidence mismatches

## 1) Design principle overstates skip behavior
- **Spec** `TECHNICAL_SPECIFICATION.md:887`
  - **Old:** `4. **Graceful Degradation:** Each step can be skipped if dependencies are unavailable`
- **Why mismatch:**
  - Some steps can skip (`analyze/retrieve/semantic_search/compare`), but not **each** step.
  - `initialize` errors if embeddings missing (not skipped): `src/enso_atlas/agent/workflow.py:273-280`
  - `reason` has no dependency-gated skip path: `src/enso_atlas/agent/workflow.py:688-760`
  - `report` uses fallback report when MedGemma missing (not skipped): `src/enso_atlas/agent/workflow.py:794-892`
- **Suggested replacement (exact):**
  - **New:** `4. **Graceful Degradation:** Dependency-bound steps (e.g., TransMIL inference, FAISS retrieval, MedSigLIP search) can be skipped or downgraded; initialization failures surface as explicit errors.`

## 2) Step 7 diagram implies mandatory MedGemma call, but implementation is conditional
- **Spec** `TECHNICAL_SPECIFICATION.md:931-934`
  - **Old:**
    - `Note over Agent: Step 7: REPORT`
    - `Agent->>MedGemma: generate_report()`
    - `MedGemma-->>Agent: structured report`
    - `Agent-->>Client: SSE: report complete (10-120s)`
- **Why mismatch:**
  - MedGemma call happens only when `medgemma_reporter is not None`; otherwise code generates structured fallback report locally.
  - Conditional MedGemma path: `src/enso_atlas/agent/workflow.py:794-825`
  - Non-MedGemma fallback report path: `src/enso_atlas/agent/workflow.py:826-892`
- **Suggested replacement (exact):**
  - **New:**
    - `Note over Agent: Step 7: REPORT`
    - `alt MedGemma available`
    - `  Agent->>MedGemma: generate_report()`
    - `  MedGemma-->>Agent: structured report`
    - `else fallback`
    - `  Agent->>Agent: build structured report from predictions/evidence/retrieval`
    - `end`
    - `Agent-->>Client: SSE: report complete`

## 3) SSE example text claims "project-scoped models" but agent analyze request is not project-scoped
- **Spec** `TECHNICAL_SPECIFICATION.md:943`
  - **Old:** `"message": "Ran project-scoped models on 6,234 patches",`
- **Why mismatch:**
  - `/api/agent/analyze` request schema has `slide_id`, `clinical_context`, `questions`; no `project_id`: `src/enso_atlas/agent/routes.py:26-38`
  - Workflow runs against the preconfigured `embeddings_dir` and model handles set at startup, not per-request project scope: `src/enso_atlas/agent/workflow.py:145-166`, `src/enso_atlas/api/main.py:1426-1437`
  - Actual emitted message format is `Ran {len(state.predictions)} models on {n_patches} patches`: `src/enso_atlas/agent/workflow.py:379-383`
- **Suggested replacement (exact):**
  - **New:** `"message": "Ran 3 models on 6,234 patches",`
