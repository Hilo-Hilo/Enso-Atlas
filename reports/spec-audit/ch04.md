# Chapter 4 Audit (high-confidence mismatches only)

Scope: `TECHNICAL_SPECIFICATION.md` lines ~583–663.

## 1) Hyperparameter row: Dropout value/semantics are inaccurate
- **Spec** `TECHNICAL_SPECIFICATION.md:613`
  - **Old:** `| Dropout | 0.1 (inference) / 0.25 (training) | Via --dropout training arg |`
- **Evidence:**
  - Default TransMIL constructor uses one dropout value (not separate inference/train values): `models/transmil.py:75,87,106`
  - Training script default is `0.1`: `scripts/train_transmil.py:132`
  - Alternate training script default is `0.25`: `scripts/train_transmil_v2.py:123`
  - Inference runs in eval mode (`model.eval()`), so dropout is disabled at inference-time: `scripts/multi_model_inference.py:217`, `src/enso_atlas/mil/clam.py:738,776`
- **Suggested replacement (exact):**
  - **New:** `| Dropout | 0.1 or 0.25 (checkpoint/training-config dependent; disabled during eval) | Via --dropout training arg |`

## 2) Hyperparameter row: Total parameter count is overstated
- **Spec** `TECHNICAL_SPECIFICATION.md:614`
  - **Old:** `| Total Parameters | ~3.2M | Varies with hidden_dim/layers |`
- **Evidence:**
  - Default architecture dimensions used for this section: `models/transmil.py:70-75`
  - Parameter count is derived from the instantiated model in training code: `scripts/train_transmil.py:205-215`
  - For default `(input_dim=384, hidden_dim=512, num_layers=2, num_heads=8)`, the model has **2,477,569 (~2.48M)** parameters.
- **Suggested replacement (exact):**
  - **New:** `| Total Parameters | ~2.48M (2,477,569 with default 384→512, 2 layers, 8 heads) | Varies with hidden_dim/layers |`

## 3) Threshold optimization block conflicts with repo threshold config
- **Spec** `TECHNICAL_SPECIFICATION.md:635-645`
  - **Old (claims Youden-J threshold 0.9229 in JSON + narrative):**
```json
{
  "method": "youden_j",
  "threshold": 0.9229,
  "sensitivity": 0.846,
  "specificity": 0.912,
  "auc": 0.879
}
```
  - **Old sentence:** `The high threshold (0.9229 vs default 0.5) reflects the class imbalance (139:13) and optimizes for balanced sensitivity/specificity.`
- **Evidence:**
  - Current threshold config in repo is placeholder with no computed Youden optimum: `models/threshold_config.json:8-11`
  - Runtime threshold resolution uses explicit config threshold or `recommended_threshold` from threshold config (currently 0.5): `src/enso_atlas/mil/clam.py:166-174`
  - API startup passes threshold from env (optional) and defaults to threshold config path: `src/enso_atlas/api/main.py:1155-1178`
- **Suggested replacement (exact):**
  - **New JSON block:**
```json
{
  "auc_roc": 0.879,
  "n_slides": 152,
  "n_positive": 139,
  "n_negative": 13,
  "optimal_threshold_youden": null,
  "optimal_threshold_f1": null,
  "recommended_threshold": 0.5,
  "note": "Placeholder -- run scripts/optimize_threshold.py on DGX Spark to compute the real optimal threshold."
}
```
  - **New sentence:** `Current repository threshold config is a placeholder (recommended_threshold=0.5); Youden-J optimized threshold is not yet materialized in models/threshold_config.json.`

## 4) Training scheduler row does not match the documented training pipeline script
- **Spec** `TECHNICAL_SPECIFICATION.md:652`
  - **Old:** `| Scheduler | CosineAnnealingLR (T_max=50, eta_min=1e-6) |`
- **Evidence:**
  - `scripts/train_transmil.py` (the documented training pipeline) uses `CosineAnnealingWarmRestarts(T_0=10, T_mult=2, eta_min=1e-6)`: `scripts/train_transmil.py:221-223`
- **Suggested replacement (exact):**
  - **New:** `| Scheduler | CosineAnnealingWarmRestarts (T_0=10, T_mult=2, eta_min=1e-6) |`
