# Chapter 2 Audit (high-confidence mismatches only)

Scope: `TECHNICAL_SPECIFICATION.md` lines ~156–433.

## 1) OpenSeadragon version is outdated
- **Spec** `TECHNICAL_SPECIFICATION.md:286`
  - **Old:** `- **WSI Viewer:** OpenSeadragon 4.1 for Deep Zoom Image (DZI) tile-based rendering with SVG annotation overlay, canvas-based patch heatmap overlays, and patch grid overlay`
- **Evidence:** `frontend/package.json:18` (`"openseadragon": "^5.0.1"`)
- **Suggested replacement (exact):**
  - **New:** `- **WSI Viewer:** OpenSeadragon 5.0.1 for Deep Zoom Image (DZI) tile-based rendering with SVG annotation overlay, canvas-based patch heatmap overlays, and patch grid overlay`

## 2) API client size + SSE claim is inaccurate
- **Spec** `TECHNICAL_SPECIFICATION.md:289`
  - **Old:** `- **API Communication:** Custom fetch wrapper (2,625 lines) with retry logic, timeout handling, SSE streaming, and typed error handling`
- **Evidence:**
  - `frontend/src/lib/api.ts:3054` (file ends at line 3054)
  - No SSE client usage in `api.ts` (`EventSource`/`text/event-stream`/`getReader` not present)
  - Polling is used instead: `frontend/src/lib/api.ts:2172-2225`, `2482-2496`, `2739-2763`
- **Suggested replacement (exact):**
  - **New:** `- **API Communication:** Custom fetch wrapper (3,054 lines) with retry logic, timeout handling, polling-based progress tracking, and typed error handling`

## 3) Dark mode implementation wording is misleading
- **Spec** `TECHNICAL_SPECIFICATION.md:290`
  - **Old:** `- **Dark Mode:** Full dark mode support via Tailwind CSS dark variant`
- **Evidence:**
  - Theme toggling via root class: `frontend/src/components/modals/SettingsModal.tsx:62-79`
  - Dark theme variables in CSS: `frontend/src/app/globals.css:39-47`
  - No `dark:` utility usage detected across `frontend/src`
- **Suggested replacement (exact):**
  - **New:** `- **Dark Mode:** Theme toggling is implemented via a root ".dark" class and CSS variables; Tailwind dark-variant utility usage is limited.`

## 4) `main.py` line count is stale
- **Spec** `TECHNICAL_SPECIFICATION.md:294`
  - **Old:** `- **Primary Module:** \`src/enso_atlas/api/main.py\` (6,119 lines), containing all core endpoints, model loading, and startup orchestration`
- **Evidence:** `src/enso_atlas/api/main.py` has 7,072 lines (`wc -l`)
- **Suggested replacement (exact):**
  - **New:** `- **Primary Module:** \`src/enso_atlas/api/main.py\` (7,072 lines), containing all core endpoints, model loading, and startup orchestration`

## 5) Path Foundation is not strictly “CPU-only” in codebase
- **Spec** `TECHNICAL_SPECIFICATION.md:299`
  - **Old:** `- **Path Foundation:** TensorFlow SavedModel producing 384-dim patch embeddings (CPU-only due to Blackwell TF incompatibility)`
- **Evidence:**
  - `/api/embed` uses `PathFoundationEmbedder` (Transformers/PyTorch): `src/enso_atlas/api/main.py:4250-4282`
  - Embedder chooses CUDA/MPS/CPU automatically: `src/enso_atlas/embedding/embedder.py:58-63,92-95`
  - Separate TF embedding path forces CPU in inline/single-slide flow: `src/enso_atlas/api/main.py:5766,5884`
- **Suggested replacement (exact):**
  - **New:** `- **Path Foundation:** 384-dim patch embeddings are served via two paths: Transformers/PyTorch for \`/api/embed\` (device auto: CUDA/MPS/CPU) and TensorFlow SavedModel for slide re-embedding endpoints (typically CPU-forced in inline/single-slide flows).`

## 6) “TransMIL x5” is inconsistent with current model catalog
- **Spec** `TECHNICAL_SPECIFICATION.md:223,324,357`
  - **Old (3 places):** `TransMIL x5`
- **Evidence:**
  - Six configured classification models: `config/projects.yaml:45-105` (includes `lung_stage` + 5 ovarian models)
- **Suggested replacements (exact):**
  - `TM[TransMIL x5]` -> `TM[TransMIL x6]`
  - `TRANSMIL[TransMIL x5<br/>Classification]` -> `TRANSMIL[TransMIL x6<br/>Classification]`
  - `|  - TransMIL x5 (GPU)             |` -> `|  - TransMIL x6 (GPU)             |`

## 7) Network rewrite example is now env-configurable, not fixed
- **Spec** `TECHNICAL_SPECIFICATION.md:391-401`
  - **Old block:**
```javascript
const nextConfig = {
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://127.0.0.1:8003/api/:path*',
      },
    ]
  },
};
```
- **Evidence:** `frontend/next.config.mjs:25-31` uses `${process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:8003'}`
- **Suggested replacement (exact):**
```javascript
const nextConfig = {
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: `${process.env.NEXT_PUBLIC_API_URL || 'http://127.0.0.1:8003'}/api/:path*`,
      },
    ]
  },
};
```

## 8) Data-flow “tissue masking” conflicts with current dense level-0 embedding policy
- **Spec** `TECHNICAL_SPECIFICATION.md:318-319`
  - **Old:**
    - `PATCH --> TISSUE[Tissue Masking<br/>Background Removal]`
    - `TISSUE --> PF_EMB[Path Foundation<br/>Embedding]`
- **Evidence:** current API embedding flows keep all grid patches (dense policy):
  - `src/enso_atlas/api/main.py:5729`
  - `src/enso_atlas/api/main.py:6117-6119`
- **Suggested replacement (exact):**
  - `PATCH --> TISSUE[Tissue Masking<br/>Background Removal]` -> `PATCH --> PF_EMB[Path Foundation<br/>Embedding (dense level-0 grid)]`
  - `TISSUE --> PF_EMB[Path Foundation<br/>Embedding]` -> *(remove this edge)*
