# Chapter 13 spec audit (high-confidence mismatches only)

## 1) Repository directory name is wrong in multiple commands

**Old (13.2 Step 1, 13.10 Upgrading, 13.6 Walkthrough Step 2):**
```bash
git clone https://github.com/Hilo-Hilo/enso-atlas.git
cd med-gemma-hackathon
```
(and `cd med-gemma-hackathon/docker`)

**New (suggested):**
```bash
git clone https://github.com/Hilo-Hilo/enso-atlas.git
cd enso-atlas
```
(and `cd enso-atlas/docker`)

---

## 2) `embed_level0_pipelined.py` CLI flags are incorrect (underscore/plural forms)

**Old (13.4.1 Step 2, 13.5.3 Option C):**
```bash
python scripts/embed_level0_pipelined.py \
  --slides_dir ... \
  --output_dir ... \
  --patch_size 224 \
  --batch_size 512
```

**New (suggested):**
```bash
python scripts/embed_level0_pipelined.py \
  --slide-dir ... \
  --output-dir ... \
  --patch-size 224 \
  --batch-size 512
```

---

## 3) `train_transmil.py` labels format mismatch

**Old (13.4.1 Step 3):**
```bash
python scripts/train_transmil.py \
  --embeddings_dir ... \
  --labels_file data/projects/breast-her2/labels.csv \
  --output_dir ...
```

**New (suggested):**
```bash
python scripts/train_transmil.py \
  --embeddings_dir ... \
  --labels_file data/projects/breast-her2/labels.json \
  --output_dir ...
```
(If using CSV, use `train_transmil_finetune.py` instead.)

---

## 4) `optimize_threshold.py` arguments are wrong

**Old (13.4.1 Step 4):**
```bash
python scripts/optimize_threshold.py \
  --embeddings_dir ... \
  --labels_file ... \
  --model_path outputs/transmil_her2/best_model.pt \
  --output outputs/transmil_her2/threshold_config.json
```

**New (suggested):**
```bash
python scripts/optimize_threshold.py \
  --checkpoint outputs/transmil_her2/best_model.pt \
  --embeddings_dir ... \
  --labels_file ... \
  --output_dir outputs/transmil_her2
```

---

## 5) Environment default for `MIL_ARCHITECTURE` is incorrect in table

**Old (13.6.2 table):**
> `MIL_ARCHITECTURE` default: `transmil`

**New (suggested):**
> `MIL_ARCHITECTURE` default: `clam` (Docker compose overrides to `transmil`)

---

## 6) Walkthrough Step 4 embedding command includes unsupported flag

**Old (13.6 Walkthrough Step 4):**
```bash
python scripts/embed_level0_pipelined.py \
  --slides-dir /data/lung_slides \
  --output-dir /data/lung_embeddings \
  --batch-size 512 --threads 32
```

**New (suggested):**
```bash
python scripts/embed_level0_pipelined.py \
  --slide-dir /data/lung_slides \
  --output-dir /data/lung_embeddings \
  --batch-size 512
```

---

## 7) Walkthrough Step 4 training command uses non-existent flags and wrong output root

**Old (13.6 Walkthrough Step 4):**
```bash
python scripts/train_transmil.py \
  --embeddings-dir /data/lung_embeddings \
  --labels /data/lung_labels.csv \
  --output-dir models/egfr_transmil_v1 \
  --target-column egfr_status \
  --positive-class mutant
```

**New (suggested):**
```bash
python scripts/train_transmil_finetune.py \
  --embeddings_dir /data/lung_embeddings \
  --labels_file /data/lung_labels.csv \
  --output_dir outputs/egfr_transmil_v1
```
(And labels CSV should be `slide_id,label`.)

---

## 8) Walkthrough copy step is a no-op / invalid

**Old (13.6 Walkthrough Step 4):**
```bash
cp models/egfr_transmil_v1/best_model.pt models/egfr_transmil_v1/
```

**New (suggested):**
```bash
# No copy needed if training output_dir is already outputs/egfr_transmil_v1
```
