# Chapter 3 Spec Audit (Path Foundation / MedGemma / MedSigLIP)

Only high-confidence mismatches are listed below.

## 1) Path Foundation patching strategy overstates tissue masking behavior
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:461-466`
- **Code evidence:**
  - Dense/no-filter in API re-embed: `src/enso_atlas/api/main.py:5720-5731` ("keep all grid patches")
  - Scripted tissue filters are different thresholds: `scripts/generate_embeddings_pathfoundation.py:236-247`
- **Old → New**
  - **Old:** `2. **Tissue Detection:** Pixels with mean intensity < 245 and standard deviation > 10 are considered tissue (relaxed thresholds for maximum patch coverage)`
  - **New:** `2. **Patch Selection:** /api/embed-slide uses a dense level-0 grid with no tissue filtering (all 224x224 tiles kept). Optional offline scripts use stricter patch-level filters: mean intensity 30-230, std >= 15, and non-white ratio >= tissue_threshold (default 0.15).`

## 2) Path Foundation framework/runtime is not TensorFlow-only
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:455`
- **Code evidence:**
  - Transformers runtime for `/api/embed`: `src/enso_atlas/embedding/embedder.py:55,88-89`; used in `src/enso_atlas/api/main.py:4281`
  - TensorFlow SavedModel runtime for `/api/embed-slide`: `src/enso_atlas/api/main.py:5779-5780`
- **Old → New**
  - **Old:** `| Framework | TensorFlow SavedModel |`
  - **New:** `| Framework | Mixed runtime: Transformers AutoModel (for /api/embed) and TensorFlow SavedModel (for /api/embed-slide re-embedding) |`

## 3) MedGemma default model identifier is local path, not HF ID
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:495`
- **Code evidence:** `src/enso_atlas/reporting/medgemma.py:63`
- **Old → New**
  - **Old:** `| Model ID | `google/medgemma-4b-it` |`
  - **New:** `| Model ID | `/app/models/medgemma-4b-it` (default local path); `google/medgemma-4b-it` when configured |`

## 4) MedGemma non-blocking behavior is not exclusively `asyncio.to_thread()`
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:511`
- **Code evidence:**
  - Uses `asyncio.to_thread`: `src/enso_atlas/api/main.py:1226`, `src/enso_atlas/agent/workflow.py:821`
  - Also uses explicit `threading.Thread` + timeout join: `src/enso_atlas/api/main.py:3684-3701`
- **Old → New**
  - **Old:** `5. **Non-Blocking:** All inference wrapped in `asyncio.to_thread()` to avoid blocking the event loop`
  - **New:** `5. **Non-Blocking:** Inference runs in worker threads: `asyncio.to_thread()` in async paths and a dedicated `threading.Thread` + timeout in report-task execution.`

## 5) MedSigLIP model selection in runtime is path-first, then SigLIP fallback
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:544`
- **Code evidence:** `src/enso_atlas/embedding/medsiglip.py:34-44,57-59`
- **Old → New**
  - **Old:** `| Model ID | `google/medsiglip-448` (preferred) or `google/siglip-so400m-patch14-384` (fallback) |`
  - **New:** `| Model ID | Auto-resolved local path (`MEDSIGLIP_MODEL_PATH`, `/app/models/medsiglip`, etc.); fallback `google/siglip-so400m-patch14-384` |`

## 6) MedSigLIP semantic search has an additional non-embedding fallback path
- **Spec lines:** `TECHNICAL_SPECIFICATION.md:554`
- **Code evidence:** fallback branch returns `model_used = "tissue-type-fallback"` when SigLIP embeddings unavailable/fail: `src/enso_atlas/api/main.py:4488-4490,4532-4581`
- **Old → New**
  - **Old:** `- **On-the-Fly Embedding:** When cached MedSigLIP embeddings are unavailable, patches are extracted from the WSI and embedded in real-time`
  - **New:** `- **On-the-Fly Embedding + Fallback:** If cached embeddings are missing, the service attempts real-time MedSigLIP embedding from WSI patches; if unavailable or failed, it falls back to query-aware tissue-type ranking (`model_used: tissue-type-fallback`).`
