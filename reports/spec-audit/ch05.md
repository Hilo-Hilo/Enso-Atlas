# Chapter 5 Audit (Backend startup/API scope) — high-confidence mismatches only

## 1) `main.py` line count is stale
**Old (spec):**
`The FastAPI application is created via create_app() in src/enso_atlas/api/main.py (6,119 lines).`

**New (suggested):**
`The FastAPI application is created via create_app() in src/enso_atlas/api/main.py (7,072 lines as of this revision).`

**Evidence:**
- Spec: `TECHNICAL_SPECIFICATION.md:666`
- Code extends to line 7072: `src/enso_atlas/api/main.py:7072`

---

## 2) Startup step 1 overstates TransMIL as always used
**Old (spec):**
`1. MIL Classifier (TransMIL checkpoint) ~2s`

**New (suggested):**
`1. MIL classifier load (~2s): architecture from MIL_ARCHITECTURE (default clam); TransMIL checkpoint only when MIL_ARCHITECTURE=transmil.`

**Evidence:**
- Spec: `TECHNICAL_SPECIFICATION.md:669`
- Implementation: `mil_arch = os.environ.get("MIL_ARCHITECTURE", "clam")` at `src/enso_atlas/api/main.py:1154`; TransMIL branch only at `:1166-1168`

---

## 3) Startup step 15 is inaccurate about ChatManager timing/location
**Old (spec):**
`15. Chat Manager Initialization ~0.1s` (inside startup sequence)

**New (suggested):**
`ChatManager is initialized during create_app() route wiring (outside @app.on_event("startup")); startup event loads models.`

**Evidence:**
- Spec startup sequence: `TECHNICAL_SPECIFICATION.md:668-684`
- Startup handler location: `src/enso_atlas/api/main.py:1099-1101`
- ChatManager init location: `src/enso_atlas/api/main.py:6710-6723`

---

## 4) “Complete API Endpoint Reference” missing implemented project endpoint
**Old (spec Projects section):** no `/api/projects/{id}/available-models`

**New (add row):**
`| GET | /api/projects/{id}/available-models | List project-compatible model metadata (ModelPicker source-of-truth) |`

**Evidence:**
- Spec Projects table ends without it: `TECHNICAL_SPECIFICATION.md:804-817`
- Implemented route: `src/enso_atlas/api/project_routes.py:564`

---

## 5) Tags/Groups section is incomplete vs implemented API surface
**Old (spec):** only legacy stubs
- `/api/tags`, `/api/groups` (`TECHNICAL_SPECIFICATION.md:844-851`)

**New (suggested):** keep stubs marked legacy **and add** metadata API rows (at minimum):
- `GET /api/metadata/tags`
- `GET/POST /api/metadata/groups`
- `GET/PATCH/DELETE /api/metadata/groups/{group_id}`
- `POST/DELETE /api/metadata/groups/{group_id}/slides`
- `GET /api/metadata/slides/{slide_id}`
- `POST/DELETE /api/metadata/slides/{slide_id}/tags`
- `POST /api/metadata/slides/{slide_id}/star`
- `PATCH /api/metadata/slides/{slide_id}`
- `GET /api/metadata/search`
- `POST /api/metadata/bulk/metadata`

**Evidence:**
- Metadata router prefix + endpoints: `src/enso_atlas/api/slide_metadata.py:546, 548-652`
- Router is registered: `src/enso_atlas/api/main.py:6694`

---

## 6) Project slide/model assign/unassign rows should include required request bodies
**Old (spec rows):**
- `POST /api/projects/{id}/slides | Assign slides`
- `DELETE /api/projects/{id}/slides | Unassign slides`
- `POST /api/projects/{id}/models | Assign models`
- `DELETE /api/projects/{id}/models | Unassign models`

**New (suggested row text):**
- `POST /api/projects/{id}/slides | Assign slides (body: {"slide_ids": ["..."]})`
- `DELETE /api/projects/{id}/slides | Unassign slides (body: {"slide_ids": ["..."]})`
- `POST /api/projects/{id}/models | Assign models (body: {"model_ids": ["..."]})`
- `DELETE /api/projects/{id}/models | Unassign models (body: {"model_ids": ["..."]})`

**Evidence:**
- Spec rows: `TECHNICAL_SPECIFICATION.md:810-814`
- Request schemas: `src/enso_atlas/api/project_routes.py:474-481`
- Endpoint signatures require body models: `:485, :501, :533, :549`
